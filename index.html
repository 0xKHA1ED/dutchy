<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dutch Dash - Stories</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7c7cc;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1aa;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .word {
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
            padding: 2px 0;
        }

        .word-new {
            background-color: #fef08a; /* Yellow-200 */
            color: #854d0e; /* Yellow-800 */
        }

        .word-new:hover {
            background-color: #fde047; /* Yellow-300 */
        }

        .word-known {
            background-color: transparent;
            color: inherit;
        }

        .word-known:hover {
            background-color: #e2e8f0; /* Slate-200 */
        }
    </style>
</head>

<body
    class="h-screen flex flex-col items-center justify-center overflow-hidden bg-gradient-to-br from-slate-100 to-blue-50 text-slate-800">

    <div id="app-container"
        class="w-full max-w-md md:max-w-4xl bg-white/80 backdrop-blur-xl md:rounded-[2.5rem] shadow-2xl overflow-hidden h-full md:h-[85vh] flex flex-col relative border border-white/50 ring-1 ring-black/5">

        <!-- Header -->
        <div
            class="bg-white/90 backdrop-blur-md p-4 md:p-6 text-slate-800 flex justify-between items-center border-b border-slate-100 z-10 shrink-0">
            <div class="flex items-center">
                <button id="back-button" onclick="showList()"
                    class="hidden mr-4 text-slate-500 hover:text-indigo-600 transition p-2 rounded-full hover:bg-slate-100">
                    <i class="fas fa-chevron-left text-lg"></i>
                </button>
                <h1 id="header-title" class="font-extrabold text-xl tracking-tight text-slate-800 flex items-center">
                    <i class="fas fa-book-open mr-2 text-indigo-600"></i>Stories
                </h1>
            </div>
            <!-- Stats Counter -->
            <div id="stats-display" class="flex items-center bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-full text-sm font-bold shadow-sm border border-indigo-100">
                <i class="fas fa-trophy mr-2 text-yellow-500"></i>
                <span id="known-count">0</span>
            </div>
        </div>

        <!-- Progress Bar (Visual only for now) -->
        <div class="w-full bg-gray-200 h-1 shrink-0">
            <div class="bg-indigo-500 h-1 w-0 transition-all duration-300 shadow-[0_0_10px_rgba(99,102,241,0.5)]"></div>
        </div>

        <div class="flex-1 overflow-hidden relative">

            <!-- Story List -->
            <div id="story-list" class="absolute inset-0 p-6 md:p-10 overflow-y-auto custom-scrollbar">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800">Choose a Story</h2>
                    <p class="text-gray-500 text-sm">Practice your listening and reading skills</p>
                </div>

                <div id="stories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-4">
                    <!-- Stories will be injected here -->
                    <div class="col-span-full text-center text-slate-400 py-10">
                        <i class="fas fa-circle-notch fa-spin mr-2"></i> Loading stories...
                    </div>
                </div>
            </div>

            <!-- Story Detail -->
            <div id="story-detail" class="absolute inset-0 flex flex-col overflow-hidden bg-white hidden">
                <div class="flex-1 overflow-y-auto custom-scrollbar p-6 md:p-10 pb-32"> <!-- Added padding-bottom for popover space -->
                    <div class="max-w-3xl mx-auto">

                        <!-- Hero Image & Audio -->
                        <div class="flex flex-col md:flex-row gap-6 mb-8 items-center">
                            <div class="w-full md:w-1/3 shrink-0">
                                <div
                                    class="aspect-square rounded-2xl overflow-hidden shadow-lg border-4 border-white bg-slate-100">
                                    <img id="detail-image" src="" class="w-full h-full object-cover" alt="Story Image">
                                </div>
                            </div>
                            <div class="w-full md:w-2/3">
                                <h2 id="detail-title" class="text-3xl font-extrabold text-slate-800 mb-4 leading-tight">
                                </h2>

                                <div class="bg-indigo-50 rounded-xl p-4 border border-indigo-100">
                                    <audio id="audio-player" controls class="w-full accent-indigo-600">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                            </div>
                        </div>

                        <!-- Text Content -->
                        <div id="detail-text"
                            class="prose prose-lg prose-slate max-w-none text-slate-600 leading-relaxed">
                            <!-- Text goes here -->
                        </div>

                    </div>
                </div>
            </div>

        </div>

        <!-- Definition Card (Popover) -->
        <div id="definition-card" class="absolute bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl p-6 rounded-t-3xl shadow-[0_-5px_30px_rgba(0,0,0,0.15)] transform translate-y-full transition-transform duration-300 z-20 border-t border-white/50 ring-1 ring-black/5">
            <div class="max-w-md mx-auto">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 id="def-word" class="text-3xl font-extrabold text-slate-800 tracking-tight"></h3>
                        <p id="def-meaning" class="text-lg text-slate-600 mt-1 font-medium"></p>
                    </div>
                    <button id="close-card" class="text-slate-400 hover:text-slate-600 p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                <div class="flex gap-3 mt-6">
                    <button id="btn-toggle-known" class="flex-1 py-3 px-6 rounded-xl font-bold transition-all duration-200 flex items-center justify-center gap-2 border-2 shadow-sm active:scale-95">
                        <!-- Content set by JS -->
                    </button>
                    <a id="btn-external" href="#" target="_blank" class="px-5 py-3 rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 hover:text-slate-800 font-bold transition-all duration-200 border border-slate-200 flex items-center justify-center active:scale-95" title="Look up externally">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
            </div>
        </div>

    </div>

    <script>
        // State
        let stories = [];
        let dictionary = new Map();
        let currentStoryUniqueWords = null;

        class KnownWordsManager {
            constructor() {
                this.storageKey = 'dutch_dash_known_words';
                this.words = new Set(JSON.parse(localStorage.getItem(this.storageKey) || '[]'));
            }

            isKnown(word) {
                return this.words.has(word.toLowerCase());
            }

            addWord(word) {
                this.words.add(word.toLowerCase());
                this.save();
            }

            removeWord(word) {
                this.words.delete(word.toLowerCase());
                this.save();
            }

            toggleWord(word) {
                const lower = word.toLowerCase();
                let isKnown;
                if (this.words.has(lower)) {
                    this.words.delete(lower);
                    isKnown = false;
                } else {
                    this.words.add(lower);
                    isKnown = true;
                }
                this.save();
                return isKnown;
            }

            save() {
                localStorage.setItem(this.storageKey, JSON.stringify([...this.words]));
                updateStats();
            }
        }

        const knownWordsManager = new KnownWordsManager();

        function updateStats() {
            const el = document.getElementById('known-count');
            if(!el) return;

            if (currentStoryUniqueWords) {
                // Story stats
                let knownInStory = 0;
                currentStoryUniqueWords.forEach(word => {
                    if (knownWordsManager.isKnown(word)) {
                        knownInStory++;
                    }
                });
                el.textContent = `${knownInStory} / ${currentStoryUniqueWords.size}`;
            } else {
                // Global stats
                el.textContent = knownWordsManager.words.size;
            }
        }

        const els = {
            list: document.getElementById('story-list'),
            detail: document.getElementById('story-detail'),
            grid: document.getElementById('stories-grid'),
            backBtn: document.getElementById('back-button'),
            headerTitle: document.getElementById('header-title'),
            detailImage: document.getElementById('detail-image'),
            detailTitle: document.getElementById('detail-title'),
            detailText: document.getElementById('detail-text'),
            audioPlayer: document.getElementById('audio-player'),
            // Popover elements
            defCard: document.getElementById('definition-card'),
            defWord: document.getElementById('def-word'),
            defMeaning: document.getElementById('def-meaning'),
            btnCloseCard: document.getElementById('close-card'),
            btnToggleKnown: document.getElementById('btn-toggle-known'),
            btnExternal: document.getElementById('btn-external')
        };

        let currentSelectedWord = null;

        // Event Delegation for Word Clicks
        els.detailText.addEventListener('click', (e) => {
            if (e.target.classList.contains('word')) {
                const word = e.target.dataset.word;
                openDefinitionCard(word);
            }
        });

        // Close card handler
        els.btnCloseCard.addEventListener('click', closeDefinitionCard);

        // Toggle known handler from card
        els.btnToggleKnown.addEventListener('click', () => {
            if (currentSelectedWord) {
                const isKnown = knownWordsManager.toggleWord(currentSelectedWord);
                updateWordUI(currentSelectedWord, isKnown);
                updateCardButtonState(isKnown);
            }
        });

        function openDefinitionCard(word) {
            currentSelectedWord = word;
            const lowerWord = word.toLowerCase();

            // 1. Populate Content
            els.defWord.textContent = word;

            // External Link URL
            const googleTranslateUrl = `https://translate.google.com/?sl=nl&tl=en&text=${encodeURIComponent(word)}&op=translate`;
            els.btnExternal.href = googleTranslateUrl;

            // Definition
            const meaning = dictionary.get(lowerWord);
            if (meaning) {
                els.defMeaning.textContent = meaning;
                els.defMeaning.classList.remove('text-slate-400', 'italic');
                els.defMeaning.classList.add('text-slate-600');
            } else {
                els.defMeaning.innerHTML = `Translation not found. <a href="${googleTranslateUrl}" target="_blank" class="text-indigo-600 underline">Translate with Google</a>`;
                els.defMeaning.classList.add('text-slate-400', 'italic');
            }

            // Button State
            const isKnown = knownWordsManager.isKnown(word);
            updateCardButtonState(isKnown);

            // 2. Show Card
            els.defCard.classList.remove('translate-y-full');
        }

        function closeDefinitionCard() {
            els.defCard.classList.add('translate-y-full');
            currentSelectedWord = null;
        }

        function updateCardButtonState(isKnown) {
            if (isKnown) {
                els.btnToggleKnown.innerHTML = '<i class="fas fa-check"></i> Known';
                els.btnToggleKnown.className = "flex-1 py-3 px-6 rounded-xl font-bold transition-all duration-200 flex items-center justify-center gap-2 border-2 shadow-sm active:scale-95 bg-green-100 text-green-700 border-green-200 hover:bg-green-200";
            } else {
                els.btnToggleKnown.innerHTML = '<i class="fas fa-plus"></i> New';
                els.btnToggleKnown.className = "flex-1 py-3 px-6 rounded-xl font-bold transition-all duration-200 flex items-center justify-center gap-2 border-2 shadow-sm active:scale-95 bg-yellow-100 text-yellow-700 border-yellow-200 hover:bg-yellow-200";
            }
        }

        function updateWordUI(word, isKnown) {
            // Update all instances of this word in the text
            const allWords = els.detailText.querySelectorAll(`.word`);
            const lowerWord = word.toLowerCase();
            allWords.forEach(span => {
                if (span.dataset.word.toLowerCase() === lowerWord) {
                    if (isKnown) {
                        span.classList.remove('word-new');
                        span.classList.add('word-known');
                    } else {
                        span.classList.remove('word-known');
                        span.classList.add('word-new');
                    }
                }
            });
        }

        async function init() {
            try {
                // Load Stories
                const storiesResp = await fetch('data/stories.json');
                if (!storiesResp.ok) throw new Error('Failed to load stories');
                stories = await storiesResp.json();

                // Load Dictionary
                try {
                    const freqResp = await fetch('data/frequency.json');
                    if (freqResp.ok) {
                        const freqData = await freqResp.json();
                        buildDictionary(freqData);
                    }
                } catch (e) {
                    console.warn('Failed to load dictionary', e);
                }

                renderList();
                updateStats(); // Initial stats
            } catch (error) {
                console.error(error);
                els.grid.innerHTML = `<div class="col-span-full text-center text-red-500 py-10">Failed to load stories.<br>${error.message}</div>`;
            }
        }

        function buildDictionary(data) {
             for (const category in data) {
                if (Array.isArray(data[category])) {
                    data[category].forEach(item => {
                        const dutchWords = item.dutch.split(',').map(s => s.trim().toLowerCase());
                        dutchWords.forEach(w => {
                            if (!dictionary.has(w)) {
                                dictionary.set(w, item.english);
                            }
                        });
                    });
                }
             }
        }

        function renderList() {
            els.grid.innerHTML = '';
            stories.forEach(story => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl shadow-sm hover:shadow-xl border border-slate-100 overflow-hidden cursor-pointer transition-all duration-300 transform hover:-translate-y-1 group fade-in";
                card.onclick = () => openStory(story);

                // Use dummy image if not provided
                const imageUrl = story.image || 'https://placehold.co/400x300?text=No+Image';

                card.innerHTML = `
                    <div class="h-40 overflow-hidden bg-slate-100 relative">
                        <img src="${imageUrl}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" onerror="this.src='https://placehold.co/400x300?text=No+Image'">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                        <div class="absolute bottom-3 right-3 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-indigo-600 shadow-sm">
                            <i class="fas fa-headphones mr-1"></i> Listen
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-lg text-slate-800 mb-1 group-hover:text-indigo-600 transition-colors line-clamp-1">${story.title}</h3>
                        <p class="text-sm text-slate-400 line-clamp-2">${story.body.substring(0, 100)}...</p>
                    </div>
                `;
                els.grid.appendChild(card);
            });
        }

        function openStory(story) {
            // Populate Detail
            els.detailImage.src = story.image || 'https://placehold.co/600x600?text=Story';
            els.detailTitle.textContent = story.title;

            // Calculate story stats
            currentStoryUniqueWords = new Set();
            const paragraphs = story.body.split('\n');
            paragraphs.forEach(p => {
                const tokens = p.split(/([a-zA-Z\u00C0-\u017F]+)/);
                tokens.forEach(t => {
                    if (/^[a-zA-Z\u00C0-\u017F]+$/.test(t)) {
                        currentStoryUniqueWords.add(t.toLowerCase());
                    }
                });
            });
            updateStats();

            // Format text: tokenize and highlight
            els.detailText.innerHTML = formatStoryText(story.body);

            // Dummy audio if missing
            els.audioPlayer.src = story.audio || '#';
            els.audioPlayer.load();

            // Switch View
            els.list.classList.add('hidden');
            els.detail.classList.remove('hidden');
            els.backBtn.classList.remove('hidden');

            // Update Header
            els.headerTitle.innerHTML = `<span class="truncate max-w-[200px]">${story.title}</span>`;
        }

        function formatStoryText(text) {
            const paragraphs = text.split('\n').filter(line => line.trim() !== '');

            return paragraphs.map(paragraph => {
                // Split by word boundaries, keeping the delimiters (words vs non-words)
                // Dutch alphabet includes accented characters
                const tokens = paragraph.split(/([a-zA-Z\u00C0-\u017F]+)/);

                const html = tokens.map(token => {
                    if (/^[a-zA-Z\u00C0-\u017F]+$/.test(token)) {
                        // It is a word
                        const isKnown = knownWordsManager.isKnown(token);
                        const className = isKnown ? 'word-known' : 'word-new';
                        return `<span class="word ${className}" data-word="${token}">${token}</span>`;
                    } else {
                        // Punctuation or whitespace
                        return token;
                    }
                }).join('');

                return `<p class="mb-4 text-lg leading-loose">${html}</p>`;
            }).join('');
        }

        function showList() {
            currentStoryUniqueWords = null;
            updateStats();

            els.detail.classList.add('hidden');
            els.list.classList.remove('hidden');
            els.backBtn.classList.add('hidden');

            // Stop audio
            els.audioPlayer.pause();

            // Reset Header
            els.headerTitle.innerHTML = `<i class="fas fa-book-open mr-2 text-indigo-600"></i>Stories`;
        }

        // Initialize
        init();

    </script>
</body>

</html>