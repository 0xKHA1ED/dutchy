<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dutch Dash - Stories</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b; /* Zinc 950 */
        }

        .font-serif {
            font-family: 'Crimson Pro', serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #3f3f46; /* Zinc 700 */
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #52525b; /* Zinc 600 */
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .word {
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
            padding: 1px 0;
            position: relative;
        }

        /* "New" words - Subtle highlight/underline style */
        .word-new {
            color: #fbbf24; /* Amber 400 */
            border-bottom: 1px dotted rgba(251, 191, 36, 0.5);
        }

        .word-new:hover {
            background-color: rgba(251, 191, 36, 0.1);
            color: #fcd34d; /* Amber 300 */
        }

        /* "Known" words - Text color blends in */
        .word-known {
            color: #d4d4d8; /* Zinc 300 */
        }

        .word-known:hover {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Floating particles effect for background */
        .bg-particles {
            background-image: radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* 3D Flip Card Styles */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
    </style>
</head>

<body
    class="h-[100dvh] flex flex-col items-center justify-center overflow-hidden bg-zinc-950 text-zinc-100 bg-particles">

    <div id="app-container"
        class="w-full max-w-md md:max-w-4xl bg-zinc-900/90 backdrop-blur-2xl md:rounded-[2rem] shadow-[0_0_50px_rgba(0,0,0,0.5)] overflow-hidden h-full md:h-[85vh] flex flex-col relative border border-white/5 ring-1 ring-black">

        <!-- Header -->
        <div
            class="bg-zinc-900/80 backdrop-blur-md p-5 md:p-6 text-zinc-100 flex justify-between items-center border-b border-white/5 z-10 shrink-0">
            <div class="flex items-center gap-3">
                <button id="back-button" onclick="showList()"
                    class="hidden text-zinc-400 hover:text-white transition p-2 -ml-2 rounded-full hover:bg-white/5">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h1 id="header-title" class="font-bold text-xl tracking-tight text-white flex items-center">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-amber-200 to-yellow-500">Dutch Dash</span>
                </h1>
            </div>
            <!-- Stats Counter -->
            <div id="stats-display" class="flex items-center bg-zinc-800/50 text-zinc-300 px-3 py-1.5 rounded-full text-xs font-medium border border-white/5 hover:bg-zinc-800 transition-colors">
                <i class="fas fa-book-open mr-2 text-amber-500/80"></i>
                <span id="known-count">0</span>
            </div>
        </div>

        <!-- Progress Bar (Visual) -->
        <div class="w-full bg-zinc-800 h-[2px] shrink-0">
            <div class="bg-amber-500 h-full w-0 shadow-[0_0_10px_rgba(245,158,11,0.5)] transition-all duration-300"></div>
        </div>

        <div class="flex-1 overflow-hidden relative">

            <!-- Story List -->
            <div id="story-list" class="absolute inset-0 p-6 md:p-8 overflow-y-auto custom-scrollbar">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Library</h2>
                    <p class="text-zinc-500 text-sm">Select a story to begin reading</p>
                </div>

                <!-- Tag Filters -->
                <div class="mb-6">
                    <h3 class="text-zinc-400 text-sm font-bold uppercase tracking-wider mb-3">Filter by tags</h3>
                    <div id="tag-filters" class="flex flex-wrap gap-2">
                        <!-- Tags injected here -->
                    </div>
                </div>

                <div id="stories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 pb-10">
                    <!-- Stories will be injected here -->
                    <div class="col-span-full text-center text-zinc-500 py-20">
                        <i class="fas fa-circle-notch fa-spin mr-2"></i> Loading noir stories...
                    </div>
                </div>
            </div>

            <!-- Story Detail -->
            <div id="story-detail" class="absolute inset-0 flex flex-col overflow-hidden bg-zinc-900 hidden">
                <div class="flex-1 overflow-y-auto custom-scrollbar p-6 md:p-12 pb-40">
                    <div class="max-w-2xl mx-auto">

                        <!-- Hero Image -->
                        <div class="flex flex-col gap-6 mb-10">
                            <!-- Image Container -->
                            <div class="w-full aspect-video rounded-xl overflow-hidden shadow-2xl border border-white/10 bg-zinc-800 relative group">
                                <img id="detail-image" src="" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity duration-700" alt="Story Image">
                                <div class="absolute inset-0 bg-gradient-to-t from-zinc-900 via-transparent to-transparent"></div>

                                <!-- Title Overlay -->
                                <div class="absolute bottom-0 left-0 p-6 w-full">
                                    <h2 id="detail-title" class="text-3xl md:text-4xl font-serif font-bold text-white mb-2 leading-tight drop-shadow-lg"></h2>
                                </div>
                            </div>

                            <!-- Study Button -->
                            <button id="btn-study" class="w-full bg-zinc-800 hover:bg-zinc-700 text-amber-500 font-bold py-3 px-6 rounded-xl transition-all duration-200 border border-amber-500/20 shadow-lg flex items-center justify-center gap-2 group active:scale-95">
                                <i class="fas fa-layer-group group-hover:scale-110 transition-transform"></i>
                                <span>Study Sentences</span>
                            </button>
                        </div>

                        <!-- Text Content -->
                        <div id="detail-text"
                            class="font-serif text-xl md:text-2xl leading-loose text-zinc-300 tracking-wide selection:bg-amber-500/30 selection:text-amber-100">
                            <!-- Text goes here -->
                        </div>

                        <!-- Spacer for end of content -->
                        <div class="h-20 flex items-center justify-center text-zinc-600 mt-10">
                            <i class="fas fa-asterisk text-xs"></i>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Study View (Flashcards) -->
            <div id="study-view" class="absolute inset-0 bg-zinc-950 z-40 flex flex-col hidden">
                <!-- Header -->
                <div class="p-6 flex justify-between items-center border-b border-white/10 bg-zinc-900/50 backdrop-blur-sm">
                    <div>
                         <h2 class="text-xl font-bold text-white">Study Mode</h2>
                         <p id="study-progress" class="text-xs text-zinc-500 mt-1">Card 1 of 10</p>
                    </div>
                    <button onclick="closeStudyMode()" class="text-zinc-400 hover:text-white transition-colors p-2 rounded-full hover:bg-white/5">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <!-- Content -->
                <div class="flex-1 flex flex-col items-center justify-center p-6 relative overflow-hidden">
                    <div id="flashcard-container" class="w-full max-w-xl aspect-[4/3] relative perspective-1000 cursor-pointer group">
                        <div id="flashcard-inner" class="w-full h-full relative transition-transform duration-500 transform-style-3d">
                             <!-- Front -->
                            <div class="absolute inset-0 bg-zinc-900 border border-white/10 rounded-2xl p-6 md:p-10 flex flex-col items-center justify-center backface-hidden shadow-2xl">
                                <p class="text-zinc-600 text-xs uppercase tracking-wider font-bold mb-6">Dutch Sentence</p>
                                <p id="fc-front-text" class="text-xl md:text-3xl font-serif text-center leading-relaxed text-zinc-200"></p>
                                <p class="text-zinc-700 text-xs mt-8 flex items-center gap-2">
                                    <i class="fas fa-hand-pointer"></i> Tap to flip
                                </p>
                            </div>
                             <!-- Back -->
                            <div class="absolute inset-0 bg-zinc-800 border border-amber-500/20 rounded-2xl p-6 md:p-10 flex flex-col items-center justify-center backface-hidden rotate-y-180 shadow-2xl">
                                <p class="text-amber-500 text-xs uppercase tracking-wider font-bold mb-4">Word Analysis</p>
                                <div id="fc-back-content" class="text-base text-zinc-300 text-center mb-6 overflow-y-auto max-h-[50%] w-full custom-scrollbar flex flex-wrap justify-center gap-2">
                                    <!-- Gloss goes here -->
                                </div>
                                <div class="w-full h-[1px] bg-white/5 mb-6"></div>
                                <a id="fc-translate-link" href="#" target="_blank" class="px-4 py-2 rounded-lg bg-zinc-700/50 hover:bg-zinc-700 text-zinc-300 text-sm transition-colors border border-white/5 flex items-center gap-2 mb-2" onclick="event.stopPropagation();">
                                    <i class="fas fa-external-link-alt text-xs"></i> Google Translate
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div id="fc-controls" class="w-full max-w-xl mt-8 grid grid-cols-3 gap-4 opacity-0 pointer-events-none transition-all duration-300 transform translate-y-4">
                        <button onclick="handleRating('hard')" class="p-3 md:p-4 rounded-xl bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500/20 font-bold transition-all active:scale-95 flex flex-col items-center gap-1">
                            <span class="text-lg"><i class="fas fa-times"></i></span>
                            <span class="text-xs uppercase">Hard</span>
                        </button>
                        <button onclick="handleRating('good')" class="p-3 md:p-4 rounded-xl bg-blue-500/10 text-blue-500 border border-blue-500/20 hover:bg-blue-500/20 font-bold transition-all active:scale-95 flex flex-col items-center gap-1">
                            <span class="text-lg"><i class="fas fa-check"></i></span>
                            <span class="text-xs uppercase">Good</span>
                        </button>
                        <button onclick="handleRating('easy')" class="p-3 md:p-4 rounded-xl bg-green-500/10 text-green-500 border border-green-500/20 hover:bg-green-500/20 font-bold transition-all active:scale-95 flex flex-col items-center gap-1">
                            <span class="text-lg"><i class="fas fa-star"></i></span>
                            <span class="text-xs uppercase">Easy</span>
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Fixed Bottom Audio Player -->
        <div id="fixed-audio-player" class="absolute bottom-0 left-0 right-0 bg-zinc-900/95 backdrop-blur-xl border-t border-white/10 p-4 transform translate-y-full transition-transform duration-300 z-30 hidden">
            <div class="max-w-4xl mx-auto flex items-center gap-4">
                 <div class="w-10 h-10 rounded-full bg-amber-500/10 flex items-center justify-center text-amber-500 shrink-0">
                    <i class="fas fa-headphones"></i>
                </div>
                <div class="flex-1">
                     <audio id="audio-player" controls class="w-full h-8 accent-amber-500 opacity-80 hover:opacity-100 transition-opacity filter invert-[.9]">
                        Your browser does not support the audio element.
                    </audio>
                </div>
            </div>
        </div>


        <!-- Definition Card (Popover) -->
        <div id="definition-card" class="absolute bottom-0 left-0 right-0 bg-zinc-800/95 backdrop-blur-2xl p-6 md:p-8 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.5)] transform translate-y-full transition-transform duration-300 z-50 border-t border-white/10">
            <div class="max-w-xl mx-auto">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 id="def-word" class="text-3xl font-serif font-bold text-white tracking-wide"></h3>
                        <p id="def-meaning" class="text-lg text-amber-400 mt-1 font-medium"></p>
                    </div>
                    <button id="close-card" class="text-zinc-400 hover:text-white p-2 bg-white/5 rounded-full hover:bg-white/10 transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                <div class="flex gap-4">
                    <button id="btn-toggle-known" class="flex-1 py-3 px-6 rounded-xl font-bold transition-all duration-200 flex items-center justify-center gap-2 border active:scale-95 shadow-lg">
                        <!-- Content set by JS -->
                    </button>
                    <a id="btn-external" href="#" target="_blank" class="px-5 py-3 rounded-xl bg-zinc-700/50 text-zinc-300 hover:bg-zinc-700 hover:text-white font-semibold transition-all duration-200 border border-white/5 flex items-center justify-center active:scale-95 hover:border-white/20" title="Look up externally">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
            </div>
        </div>

    </div>

    <script>
        // State
        let stories = [];
        let dictionary = new Map();
        let currentStoryUniqueWords = null;
        let selectedTags = new Set();
        let currentStory = null;

        // Study Mode State
        let studyQueue = [];
        let currentCardIndex = 0;
        let isCardFlipped = false;

        class KnownWordsManager {
            constructor() {
                this.storageKey = 'dutch_dash_known_words';
                this.words = new Set(JSON.parse(localStorage.getItem(this.storageKey) || '[]'));
            }

            isKnown(word) {
                return this.words.has(word.toLowerCase());
            }

            addWord(word) {
                this.words.add(word.toLowerCase());
                this.save();
            }

            removeWord(word) {
                this.words.delete(word.toLowerCase());
                this.save();
            }

            toggleWord(word) {
                const lower = word.toLowerCase();
                let isKnown;
                if (this.words.has(lower)) {
                    this.words.delete(lower);
                    isKnown = false;
                } else {
                    this.words.add(lower);
                    isKnown = true;
                }
                this.save();
                return isKnown;
            }

            save() {
                localStorage.setItem(this.storageKey, JSON.stringify([...this.words]));
                updateStats();
            }
        }

        const knownWordsManager = new KnownWordsManager();

        function updateStats() {
            const el = document.getElementById('known-count');
            if(!el) return;

            if (currentStoryUniqueWords) {
                // Story stats
                let knownInStory = 0;
                currentStoryUniqueWords.forEach(word => {
                    if (knownWordsManager.isKnown(word)) {
                        knownInStory++;
                    }
                });
                const percentage = Math.round((knownInStory / currentStoryUniqueWords.size) * 100) || 0;
                el.textContent = `${percentage}% Known`;
            } else {
                // Global stats
                el.textContent = `${knownWordsManager.words.size} Words`;
            }
        }

        const els = {
            list: document.getElementById('story-list'),
            detail: document.getElementById('story-detail'),
            grid: document.getElementById('stories-grid'),
            backBtn: document.getElementById('back-button'),
            headerTitle: document.getElementById('header-title'),
            detailImage: document.getElementById('detail-image'),
            detailTitle: document.getElementById('detail-title'),
            detailText: document.getElementById('detail-text'),
            audioPlayer: document.getElementById('audio-player'),
            fixedAudioContainer: document.getElementById('fixed-audio-player'),
            btnStudy: document.getElementById('btn-study'),

            // Study View
            studyView: document.getElementById('study-view'),
            flashcardContainer: document.getElementById('flashcard-container'),
            flashcardInner: document.getElementById('flashcard-inner'),
            fcFrontText: document.getElementById('fc-front-text'),
            fcBackContent: document.getElementById('fc-back-content'),
            fcTranslateLink: document.getElementById('fc-translate-link'),
            fcControls: document.getElementById('fc-controls'),
            studyProgress: document.getElementById('study-progress'),

            // Popover elements
            defCard: document.getElementById('definition-card'),
            defWord: document.getElementById('def-word'),
            defMeaning: document.getElementById('def-meaning'),
            btnCloseCard: document.getElementById('close-card'),
            btnToggleKnown: document.getElementById('btn-toggle-known'),
            btnExternal: document.getElementById('btn-external')
        };

        let currentSelectedWord = null;

        // Event Delegation for Word Clicks
        els.detailText.addEventListener('click', (e) => {
            if (e.target.classList.contains('word')) {
                const word = e.target.dataset.word;
                openDefinitionCard(word);
            }
        });

        // Close card handler
        els.btnCloseCard.addEventListener('click', closeDefinitionCard);

        // Toggle known handler from card
        els.btnToggleKnown.addEventListener('click', () => {
            if (currentSelectedWord) {
                const isKnown = knownWordsManager.toggleWord(currentSelectedWord);
                updateWordUI(currentSelectedWord, isKnown);
                updateCardButtonState(isKnown);
                updateStats();
            }
        });

        // Study Button Handler
        els.btnStudy.addEventListener('click', openStudyMode);

        // Flashcard Flip
        els.flashcardContainer.addEventListener('click', () => {
            flipCard(!isCardFlipped);
        });

        function openDefinitionCard(word) {
            currentSelectedWord = word;
            const lowerWord = word.toLowerCase();

            // 1. Populate Content
            els.defWord.textContent = word;

            // External Link URL
            const googleTranslateUrl = `https://translate.google.com/?sl=nl&tl=en&text=${encodeURIComponent(word)}&op=translate`;
            els.btnExternal.href = googleTranslateUrl;

            // Definition
            const meaning = dictionary.get(lowerWord);
            if (meaning) {
                els.defMeaning.textContent = meaning;
                els.defMeaning.classList.remove('text-zinc-500', 'italic');
                els.defMeaning.classList.add('text-amber-400');
            } else {
                els.defMeaning.innerHTML = `Translation not found. <a href="${googleTranslateUrl}" target="_blank" class="text-amber-500 underline hover:text-amber-400">Translate</a>`;
                els.defMeaning.classList.add('text-zinc-500', 'italic');
            }

            // Button State
            const isKnown = knownWordsManager.isKnown(word);
            updateCardButtonState(isKnown);

            // 2. Show Card
            els.defCard.classList.remove('translate-y-full');
            // Hide Audio player to make room
            els.fixedAudioContainer.classList.add('translate-y-full');
        }

        function closeDefinitionCard() {
            els.defCard.classList.add('translate-y-full');
            currentSelectedWord = null;
            // Restore Audio player if we are in a story
            if (!els.detail.classList.contains('hidden') && els.studyView.classList.contains('hidden')) {
                els.fixedAudioContainer.classList.remove('translate-y-full');
            }
        }

        function updateCardButtonState(isKnown) {
            if (isKnown) {
                els.btnToggleKnown.innerHTML = '<i class="fas fa-check"></i> Known';
                els.btnToggleKnown.className = "flex-1 py-3 px-6 rounded-xl font-bold transition-all duration-200 flex items-center justify-center gap-2 border border-emerald-500/30 bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20 shadow-[0_0_15px_rgba(16,185,129,0.1)]";
            } else {
                els.btnToggleKnown.innerHTML = '<i class="fas fa-plus"></i> Add to Known';
                els.btnToggleKnown.className = "flex-1 py-3 px-6 rounded-xl font-bold transition-all duration-200 flex items-center justify-center gap-2 border border-amber-500/30 bg-amber-500/10 text-amber-400 hover:bg-amber-500/20 shadow-[0_0_15px_rgba(245,158,11,0.1)]";
            }
        }

        function updateWordUI(word, isKnown) {
            // Update all instances of this word in the text
            const allWords = els.detailText.querySelectorAll(`.word`);
            const lowerWord = word.toLowerCase();
            allWords.forEach(span => {
                if (span.dataset.word.toLowerCase() === lowerWord) {
                    if (isKnown) {
                        span.classList.remove('word-new');
                        span.classList.add('word-known');
                    } else {
                        span.classList.remove('word-known');
                        span.classList.add('word-new');
                    }
                }
            });
        }

        async function init() {
            try {
                // Load Stories
                const storiesResp = await fetch('data/stories.json');
                if (!storiesResp.ok) throw new Error('Failed to load stories');
                stories = await storiesResp.json();

                // Pre-process stories: calculate unique words for sorting
                stories.forEach(story => {
                    const uniqueWords = new Set();
                    const paragraphs = story.body.split('\n');
                    paragraphs.forEach(p => {
                        const tokens = p.split(/([a-zA-Z\u00C0-\u017F]+)/);
                        tokens.forEach(t => {
                            if (/^[a-zA-Z\u00C0-\u017F]+$/.test(t)) {
                                uniqueWords.add(t.toLowerCase());
                            }
                        });
                    });
                    story.uniqueWordSet = uniqueWords;
                });

                renderTags();

                // Load Dictionary
                try {
                    const freqResp = await fetch('data/frequency.json');
                    if (freqResp.ok) {
                        const freqData = await freqResp.json();
                        buildDictionary(freqData);
                    }
                } catch (e) {
                    console.warn('Failed to load dictionary', e);
                }

                renderList();
                updateStats(); // Initial stats
            } catch (error) {
                console.error(error);
                els.grid.innerHTML = `<div class="col-span-full text-center text-red-500 py-10">Failed to load stories.<br>${error.message}</div>`;
            }
        }

        function buildDictionary(data) {
             for (const category in data) {
                if (Array.isArray(data[category])) {
                    data[category].forEach(item => {
                        const dutchWords = item.dutch.split(',').map(s => s.trim().toLowerCase());
                        dutchWords.forEach(w => {
                            if (!dictionary.has(w)) {
                                dictionary.set(w, item.english);
                            }
                        });
                    });
                }
             }
        }

        function renderTags() {
            const tagContainer = document.getElementById('tag-filters');
            if (!tagContainer) return;

            const allTags = new Set();
            stories.forEach(story => {
                if (story.tags) {
                    story.tags.forEach(tag => allTags.add(tag));
                }
            });

            const sortedTags = Array.from(allTags).sort();

            tagContainer.innerHTML = '';
            sortedTags.forEach(tag => {
                const btn = document.createElement('button');
                btn.className = `px-3 py-1.5 rounded-full text-xs font-medium border transition-colors ${selectedTags.has(tag)
                    ? 'bg-amber-500 text-black border-amber-500'
                    : 'bg-zinc-800 text-zinc-400 border-zinc-700 hover:border-zinc-500 hover:text-white'}`;
                btn.textContent = tag;
                btn.onclick = () => {
                    if (selectedTags.has(tag)) {
                        selectedTags.delete(tag);
                    } else {
                        selectedTags.add(tag);
                    }
                    renderTags();
                    renderList();
                };
                tagContainer.appendChild(btn);
            });
        }

        function renderList() {
            els.grid.innerHTML = '';

            // Calculate stats and sort
            const storiesWithStats = stories.map(story => {
                let knownCount = 0;
                if (story.uniqueWordSet) {
                    story.uniqueWordSet.forEach(word => {
                        if (knownWordsManager.isKnown(word)) {
                            knownCount++;
                        }
                    });
                }
                const total = story.uniqueWordSet ? story.uniqueWordSet.size : 1;
                const percentage = (knownCount / total) * 100;
                return { ...story, knownPercentage: percentage };
            });

            // Sort: Highest known percentage first
            storiesWithStats.sort((a, b) => b.knownPercentage - a.knownPercentage);

            // Filter
            const filteredStories = storiesWithStats.filter(story => {
                if (selectedTags.size === 0) return true;
                if (!story.tags) return false;
                // OR logic: show if story has AT LEAST ONE selected tag
                return story.tags.some(tag => selectedTags.has(tag));
            });

            filteredStories.forEach(story => {
                const card = document.createElement('div');
                card.className = "bg-zinc-800/50 rounded-xl border border-white/5 overflow-hidden cursor-pointer transition-all duration-300 transform hover:-translate-y-1 hover:shadow-2xl hover:border-amber-500/30 group fade-in flex flex-col";
                card.onclick = () => openStory(story);

                // Use dummy image if not provided
                const imageUrl = story.image || 'https://placehold.co/400x300/18181b/a1a1aa?text=No+Image';

                // Format tags for display
                const tagHtml = story.tags ? story.tags.slice(0, 3).map(tag =>
                    `<span class="text-[10px] uppercase font-bold tracking-wider bg-black/50 px-2 py-1 rounded text-zinc-300 border border-white/10">${tag}</span>`
                ).join('') : '';

                card.innerHTML = `
                    <div class="h-44 overflow-hidden bg-zinc-800 relative shrink-0">
                        <img src="${imageUrl}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 opacity-80 group-hover:opacity-100" onerror="this.src='https://placehold.co/400x300/18181b/a1a1aa?text=No+Image'">
                        <div class="absolute inset-0 bg-gradient-to-t from-zinc-900/90 to-transparent"></div>
                        <div class="absolute top-3 right-3 flex flex-col items-end gap-2">
                             <div class="bg-black/60 backdrop-blur px-2 py-1 rounded border border-white/10 text-xs font-bold ${story.knownPercentage === 100 ? 'text-emerald-400 border-emerald-500/30' : 'text-amber-400 border-amber-500/30'}">
                                ${Math.round(story.knownPercentage)}% Known
                             </div>
                        </div>
                        <div class="absolute bottom-3 left-3 right-3 flex justify-between items-end">
                             <div class="flex flex-wrap gap-1">
                                ${tagHtml}
                             </div>
                        </div>
                    </div>
                    <div class="p-5 flex-1 flex flex-col">
                        <h3 class="font-bold text-lg text-zinc-100 mb-2 group-hover:text-amber-400 transition-colors line-clamp-1">${story.title}</h3>
                        <p class="text-sm text-zinc-400 line-clamp-3 leading-relaxed">${story.body.substring(0, 120)}...</p>
                    </div>
                `;
                els.grid.appendChild(card);
            });

            if (filteredStories.length === 0) {
                els.grid.innerHTML = `<div class="col-span-full text-center text-zinc-500 py-20">No stories found with these tags.</div>`;
            }
        }

        function openStory(story) {
            currentStory = story;
            // Populate Detail
            els.detailImage.src = story.image || 'https://placehold.co/600x600/18181b/a1a1aa?text=Story';
            els.detailTitle.textContent = story.title;

            // Calculate story stats
            currentStoryUniqueWords = new Set();
            const paragraphs = story.body.split('\n');
            paragraphs.forEach(p => {
                const tokens = p.split(/([a-zA-Z\u00C0-\u017F]+)/);
                tokens.forEach(t => {
                    if (/^[a-zA-Z\u00C0-\u017F]+$/.test(t)) {
                        currentStoryUniqueWords.add(t.toLowerCase());
                    }
                });
            });
            updateStats();

            // Format text: tokenize and highlight
            els.detailText.innerHTML = formatStoryText(story.body);

            // Dummy audio if missing
            els.audioPlayer.src = story.audio || '#';
            els.audioPlayer.load();

            // Switch View
            els.list.classList.add('hidden');
            els.detail.classList.remove('hidden');
            els.backBtn.classList.remove('hidden');

            // Show Audio Player
            els.fixedAudioContainer.classList.remove('hidden');
            setTimeout(() => els.fixedAudioContainer.classList.remove('translate-y-full'), 100);

            // Update Header to show just the title
            els.headerTitle.innerHTML = `<span class="truncate max-w-[200px] text-zinc-300 text-base">${story.title}</span>`;
        }

        function formatStoryText(text) {
            const paragraphs = text.split('\n').filter(line => line.trim() !== '');

            return paragraphs.map(paragraph => {
                // Split by word boundaries, keeping the delimiters (words vs non-words)
                const tokens = paragraph.split(/([a-zA-Z\u00C0-\u017F]+)/);

                const html = tokens.map(token => {
                    if (/^[a-zA-Z\u00C0-\u017F]+$/.test(token)) {
                        // It is a word
                        const isKnown = knownWordsManager.isKnown(token);
                        const className = isKnown ? 'word-known' : 'word-new';
                        return `<span class="word ${className}" data-word="${token}">${token}</span>`;
                    } else {
                        // Punctuation or whitespace
                        return token;
                    }
                }).join('');

                return `<p class="mb-6">${html}</p>`;
            }).join('');
        }

        function showList() {
            currentStory = null;
            currentStoryUniqueWords = null;
            updateStats();
            renderList(); // Re-render to update sort order

            els.detail.classList.add('hidden');
            els.list.classList.remove('hidden');
            els.backBtn.classList.add('hidden');

            // Stop and Hide audio
            els.audioPlayer.pause();
            els.fixedAudioContainer.classList.add('translate-y-full');
            setTimeout(() => els.fixedAudioContainer.classList.add('hidden'), 300);

            // Reset Header
            els.headerTitle.innerHTML = `<span class="bg-clip-text text-transparent bg-gradient-to-r from-amber-200 to-yellow-500">Dutch Dash</span>`;

            // Close card if open
            closeDefinitionCard();
        }

        // --- SRS & Persistence ---
        class SentenceSRSManager {
            constructor() {
                this.storageKey = 'dutch_dash_sentence_srs';
                this.data = JSON.parse(localStorage.getItem(this.storageKey) || '{}');
            }

            get(storyId, sentence) {
                const key = `${storyId}:${this._hash(sentence)}`;
                return this.data[key] || { box: 0, nextReview: 0 };
            }

            update(storyId, sentence, rating) {
                const key = `${storyId}:${this._hash(sentence)}`;
                let item = this.data[key] || { box: 0, nextReview: 0 };

                const now = Date.now();
                const day = 24 * 60 * 60 * 1000;

                if (rating === 'hard') {
                    item.box = 0;
                    item.nextReview = now; // Review immediately (or keep in session queue)
                } else if (rating === 'good') {
                    item.box = Math.min(item.box + 1, 5);
                    // Intervals: 1, 3, 7, 14, 30 days
                    const intervals = [0, 1, 3, 7, 14, 30];
                    item.nextReview = now + (intervals[item.box] * day);
                } else if (rating === 'easy') {
                     item.box = Math.min(item.box + 2, 5);
                     const intervals = [0, 1, 3, 7, 14, 30];
                     item.nextReview = now + (intervals[item.box] * day);
                }

                this.data[key] = item;
                this._save();
                return item;
            }

            _hash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = (hash << 5) - hash + char;
                    hash |= 0;
                }
                return hash;
            }

            _save() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.data));
            }
        }

        const srsManager = new SentenceSRSManager();

        // --- STUDY MODE LOGIC ---

        function openStudyMode() {
            if (!currentStory) return;

            const rawSentences = currentStory.body.match(/[^\.!\?]+[\.!\?]+/g);
            if (!rawSentences || rawSentences.length === 0) {
                alert('No sentences found to study.');
                return;
            }

            // Clean up and prioritize
            let items = rawSentences
                .map(s => s.trim())
                .filter(s => s.length >= 3)
                .map(s => {
                    const srs = srsManager.get(currentStory.id, s);
                    return { text: s, srs: srs };
                });

            const now = Date.now();

            // Sort: Due/Hard first, then New, then Known (Review later)
            items.sort((a, b) => {
                // Determine category: 0=Due/Hard, 1=New, 2=Future
                const getCategory = (item) => {
                    if (item.srs.nextReview === 0) return 1; // New
                    if (item.srs.nextReview <= now) return 0; // Due/Hard
                    return 2; // Future
                };

                const catA = getCategory(a);
                const catB = getCategory(b);

                if (catA !== catB) return catA - catB;

                // Within category 0 (Due/Hard)
                if (catA === 0) {
                    // "sorted by box level" (lower box first? Hard items have box 0)
                    if (a.srs.box !== b.srs.box) return a.srs.box - b.srs.box;
                    return a.srs.nextReview - b.srs.nextReview;
                }

                return a.srs.nextReview - b.srs.nextReview;
            });

            studyQueue = items.map(i => i.text);

            if (studyQueue.length === 0) return;

            currentCardIndex = 0;

            // Hide Audio (distraction)
            els.fixedAudioContainer.classList.add('translate-y-full');

            // Show View
            els.studyView.classList.remove('hidden');
            renderFlashcard();
        }

        function closeStudyMode() {
            els.studyView.classList.add('hidden');
            // Show Audio again
            els.fixedAudioContainer.classList.remove('translate-y-full');
        }

        function renderFlashcard() {
            // Reset Flip
            flipCard(false);

            const sentence = studyQueue[currentCardIndex];

            // Front
            els.fcFrontText.textContent = sentence;

            // Back: Generate Gloss
            els.fcBackContent.innerHTML = '';

            // Tokenize sentence for gloss
            const tokens = sentence.split(/([a-zA-Z\u00C0-\u017F]+)/);
            tokens.forEach(token => {
                if (/^[a-zA-Z\u00C0-\u017F]+$/.test(token)) {
                    // It is a word
                    const lower = token.toLowerCase();
                    const meaning = dictionary.get(lower);

                    if (meaning) {
                        // Word with gloss
                        const span = document.createElement('div');
                        span.className = "flex flex-col items-center mx-1 my-1";
                        span.innerHTML = `
                            <span class="text-zinc-100 font-bold border-b border-white/10 pb-0.5 mb-0.5">${token}</span>
                            <span class="text-amber-500 text-[10px] italic leading-tight max-w-[100px] truncate">${meaning.split(',')[0]}</span>
                        `;
                        els.fcBackContent.appendChild(span);
                    } else {
                        // Word without gloss
                        const span = document.createElement('span');
                        span.className = "text-zinc-500 mx-1 self-center";
                        span.textContent = token;
                        els.fcBackContent.appendChild(span);
                    }
                } else {
                    // Punctuation - add reduced margin to attach closer to previous?
                    // For simplicity in flex-wrap, we just display it.
                    const span = document.createElement('span');
                    span.className = "text-zinc-500 self-center";
                    span.textContent = token;
                    els.fcBackContent.appendChild(span);
                }
            });

            // Google Translate Link
            els.fcTranslateLink.href = `https://translate.google.com/?sl=nl&tl=en&text=${encodeURIComponent(sentence)}&op=translate`;

            // Progress
            els.studyProgress.textContent = `Card ${currentCardIndex + 1} of ${studyQueue.length}`;
        }

        function flipCard(flipped) {
            isCardFlipped = flipped;
            if (flipped) {
                els.flashcardInner.classList.add('rotate-y-180');
                // Show controls with delay
                setTimeout(() => {
                    els.fcControls.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
                }, 300);
            } else {
                els.flashcardInner.classList.remove('rotate-y-180');
                // Hide controls
                els.fcControls.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');
            }
        }

        function handleRating(rating) {
            const currentSentence = studyQueue[currentCardIndex];

            // Save to SRS
            if (currentStory) {
                srsManager.update(currentStory.id, currentSentence, rating);
            }

            if (rating === 'hard') {
                // Keep in session: push to end of queue
                studyQueue.push(currentSentence);
                // Update total count
                els.studyProgress.textContent = `Card ${currentCardIndex + 1} of ${studyQueue.length}`;
            }

            // Move to next
            currentCardIndex++;

            if (currentCardIndex >= studyQueue.length) {
                // Finished
                alert('Study session complete!');
                closeStudyMode();
            } else {
                renderFlashcard();
            }
        }

        // Initialize
        init();

    </script>
</body>

</html>