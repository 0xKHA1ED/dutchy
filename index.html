<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dutch Dash - Stories</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b; /* Zinc 950 */
        }

        .font-serif {
            font-family: 'Crimson Pro', serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #3f3f46; /* Zinc 700 */
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #52525b; /* Zinc 600 */
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .word {
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
            padding: 1px 0;
            position: relative;
        }

        /* "New" words - Subtle highlight/underline style */
        .word-new {
            color: #fbbf24; /* Amber 400 */
            border-bottom: 1px dotted rgba(251, 191, 36, 0.5);
        }

        .word-new:hover {
            background-color: rgba(251, 191, 36, 0.1);
            color: #fcd34d; /* Amber 300 */
        }

        /* "Known" words - Text color blends in */
        .word-known {
            color: #d4d4d8; /* Zinc 300 */
        }

        .word-known:hover {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Floating particles effect for background */
        .bg-particles {
            background-image: radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 30px 30px;
        }
    </style>
</head>

<body
    class="h-screen flex flex-col items-center justify-center overflow-hidden bg-zinc-950 text-zinc-100 bg-particles">

    <div id="app-container"
        class="w-full max-w-md md:max-w-4xl bg-zinc-900/90 backdrop-blur-2xl md:rounded-[2rem] shadow-[0_0_50px_rgba(0,0,0,0.5)] overflow-hidden h-full md:h-[85vh] flex flex-col relative border border-white/5 ring-1 ring-black">

        <!-- Header -->
        <div
            class="bg-zinc-900/80 backdrop-blur-md p-5 md:p-6 text-zinc-100 flex justify-between items-center border-b border-white/5 z-10 shrink-0">
            <div class="flex items-center gap-3">
                <button id="back-button" onclick="showList()"
                    class="hidden text-zinc-400 hover:text-white transition p-2 -ml-2 rounded-full hover:bg-white/5">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <h1 id="header-title" class="font-bold text-xl tracking-tight text-white flex items-center">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-amber-200 to-yellow-500">Dutch Dash</span>
                </h1>
            </div>
            <!-- Stats Counter -->
            <div id="stats-display" class="flex items-center bg-zinc-800/50 text-zinc-300 px-3 py-1.5 rounded-full text-xs font-medium border border-white/5 hover:bg-zinc-800 transition-colors">
                <i class="fas fa-book-open mr-2 text-amber-500/80"></i>
                <span id="known-count">0</span>
            </div>
        </div>

        <!-- Progress Bar (Visual) -->
        <div class="w-full bg-zinc-800 h-[2px] shrink-0">
            <div class="bg-amber-500 h-full w-0 shadow-[0_0_10px_rgba(245,158,11,0.5)] transition-all duration-300"></div>
        </div>

        <div class="flex-1 overflow-hidden relative">

            <!-- Story List -->
            <div id="story-list" class="absolute inset-0 p-6 md:p-8 overflow-y-auto custom-scrollbar">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Library</h2>
                    <p class="text-zinc-500 text-sm">Select a story to begin reading</p>
                </div>

                <div id="stories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 pb-10">
                    <!-- Stories will be injected here -->
                    <div class="col-span-full text-center text-zinc-500 py-20">
                        <i class="fas fa-circle-notch fa-spin mr-2"></i> Loading noir stories...
                    </div>
                </div>
            </div>

            <!-- Story Detail -->
            <div id="story-detail" class="absolute inset-0 flex flex-col overflow-hidden bg-zinc-900 hidden">
                <div class="flex-1 overflow-y-auto custom-scrollbar p-6 md:p-12 pb-40">
                    <div class="max-w-2xl mx-auto">

                        <!-- Hero Image & Audio -->
                        <div class="flex flex-col gap-6 mb-10">
                            <!-- Image Container -->
                            <div class="w-full aspect-video rounded-xl overflow-hidden shadow-2xl border border-white/10 bg-zinc-800 relative group">
                                <img id="detail-image" src="" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity duration-700" alt="Story Image">
                                <div class="absolute inset-0 bg-gradient-to-t from-zinc-900 via-transparent to-transparent"></div>

                                <!-- Title Overlay -->
                                <div class="absolute bottom-0 left-0 p-6 w-full">
                                    <h2 id="detail-title" class="text-3xl md:text-4xl font-serif font-bold text-white mb-2 leading-tight drop-shadow-lg"></h2>
                                </div>
                            </div>

                            <!-- Audio Player -->
                            <div class="bg-zinc-800/50 rounded-lg p-3 border border-white/5 flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-amber-500/10 flex items-center justify-center text-amber-500">
                                    <i class="fas fa-headphones"></i>
                                </div>
                                <audio id="audio-player" controls class="w-full h-8 accent-amber-500 opacity-80 hover:opacity-100 transition-opacity filter invert-[.9]">
                                    Your browser does not support the audio element.
                                </audio>
                            </div>
                        </div>

                        <!-- Text Content -->
                        <div id="detail-text"
                            class="font-serif text-xl md:text-2xl leading-loose text-zinc-300 tracking-wide selection:bg-amber-500/30 selection:text-amber-100">
                            <!-- Text goes here -->
                        </div>

                        <!-- Spacer for end of content -->
                        <div class="h-20 flex items-center justify-center text-zinc-600 mt-10">
                            <i class="fas fa-asterisk text-xs"></i>
                        </div>

                    </div>
                </div>
            </div>

        </div>

        <!-- Definition Card (Popover) -->
        <div id="definition-card" class="absolute bottom-0 left-0 right-0 bg-zinc-800/95 backdrop-blur-2xl p-6 md:p-8 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.5)] transform translate-y-full transition-transform duration-300 z-20 border-t border-white/10">
            <div class="max-w-xl mx-auto">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 id="def-word" class="text-3xl font-serif font-bold text-white tracking-wide"></h3>
                        <p id="def-meaning" class="text-lg text-amber-400 mt-1 font-medium"></p>
                    </div>
                    <button id="close-card" class="text-zinc-400 hover:text-white p-2 bg-white/5 rounded-full hover:bg-white/10 transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                <div class="flex gap-4">
                    <button id="btn-toggle-known" class="flex-1 py-3 px-6 rounded-xl font-bold transition-all duration-200 flex items-center justify-center gap-2 border active:scale-95 shadow-lg">
                        <!-- Content set by JS -->
                    </button>
                    <a id="btn-external" href="#" target="_blank" class="px-5 py-3 rounded-xl bg-zinc-700/50 text-zinc-300 hover:bg-zinc-700 hover:text-white font-semibold transition-all duration-200 border border-white/5 flex items-center justify-center active:scale-95 hover:border-white/20" title="Look up externally">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
            </div>
        </div>

    </div>

    <script>
        // State
        let stories = [];
        let dictionary = new Map();
        let currentStoryUniqueWords = null;

        class KnownWordsManager {
            constructor() {
                this.storageKey = 'dutch_dash_known_words';
                this.words = new Set(JSON.parse(localStorage.getItem(this.storageKey) || '[]'));
            }

            isKnown(word) {
                return this.words.has(word.toLowerCase());
            }

            addWord(word) {
                this.words.add(word.toLowerCase());
                this.save();
            }

            removeWord(word) {
                this.words.delete(word.toLowerCase());
                this.save();
            }

            toggleWord(word) {
                const lower = word.toLowerCase();
                let isKnown;
                if (this.words.has(lower)) {
                    this.words.delete(lower);
                    isKnown = false;
                } else {
                    this.words.add(lower);
                    isKnown = true;
                }
                this.save();
                return isKnown;
            }

            save() {
                localStorage.setItem(this.storageKey, JSON.stringify([...this.words]));
                updateStats();
            }
        }

        const knownWordsManager = new KnownWordsManager();

        function updateStats() {
            const el = document.getElementById('known-count');
            if(!el) return;

            if (currentStoryUniqueWords) {
                // Story stats
                let knownInStory = 0;
                currentStoryUniqueWords.forEach(word => {
                    if (knownWordsManager.isKnown(word)) {
                        knownInStory++;
                    }
                });
                const percentage = Math.round((knownInStory / currentStoryUniqueWords.size) * 100) || 0;
                el.textContent = `${percentage}% Known`;
            } else {
                // Global stats
                el.textContent = `${knownWordsManager.words.size} Words`;
            }
        }

        const els = {
            list: document.getElementById('story-list'),
            detail: document.getElementById('story-detail'),
            grid: document.getElementById('stories-grid'),
            backBtn: document.getElementById('back-button'),
            headerTitle: document.getElementById('header-title'),
            detailImage: document.getElementById('detail-image'),
            detailTitle: document.getElementById('detail-title'),
            detailText: document.getElementById('detail-text'),
            audioPlayer: document.getElementById('audio-player'),
            // Popover elements
            defCard: document.getElementById('definition-card'),
            defWord: document.getElementById('def-word'),
            defMeaning: document.getElementById('def-meaning'),
            btnCloseCard: document.getElementById('close-card'),
            btnToggleKnown: document.getElementById('btn-toggle-known'),
            btnExternal: document.getElementById('btn-external')
        };

        let currentSelectedWord = null;

        // Event Delegation for Word Clicks
        els.detailText.addEventListener('click', (e) => {
            if (e.target.classList.contains('word')) {
                const word = e.target.dataset.word;
                openDefinitionCard(word);
            }
        });

        // Close card handler
        els.btnCloseCard.addEventListener('click', closeDefinitionCard);

        // Toggle known handler from card
        els.btnToggleKnown.addEventListener('click', () => {
            if (currentSelectedWord) {
                const isKnown = knownWordsManager.toggleWord(currentSelectedWord);
                updateWordUI(currentSelectedWord, isKnown);
                updateCardButtonState(isKnown);
                updateStats();
            }
        });

        function openDefinitionCard(word) {
            currentSelectedWord = word;
            const lowerWord = word.toLowerCase();

            // 1. Populate Content
            els.defWord.textContent = word;

            // External Link URL
            const googleTranslateUrl = `https://translate.google.com/?sl=nl&tl=en&text=${encodeURIComponent(word)}&op=translate`;
            els.btnExternal.href = googleTranslateUrl;

            // Definition
            const meaning = dictionary.get(lowerWord);
            if (meaning) {
                els.defMeaning.textContent = meaning;
                els.defMeaning.classList.remove('text-zinc-500', 'italic');
                els.defMeaning.classList.add('text-amber-400');
            } else {
                els.defMeaning.innerHTML = `Translation not found. <a href="${googleTranslateUrl}" target="_blank" class="text-amber-500 underline hover:text-amber-400">Translate</a>`;
                els.defMeaning.classList.add('text-zinc-500', 'italic');
            }

            // Button State
            const isKnown = knownWordsManager.isKnown(word);
            updateCardButtonState(isKnown);

            // 2. Show Card
            els.defCard.classList.remove('translate-y-full');
        }

        function closeDefinitionCard() {
            els.defCard.classList.add('translate-y-full');
            currentSelectedWord = null;
        }

        function updateCardButtonState(isKnown) {
            if (isKnown) {
                els.btnToggleKnown.innerHTML = '<i class="fas fa-check"></i> Known';
                els.btnToggleKnown.className = "flex-1 py-3 px-6 rounded-xl font-bold transition-all duration-200 flex items-center justify-center gap-2 border border-emerald-500/30 bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20 shadow-[0_0_15px_rgba(16,185,129,0.1)]";
            } else {
                els.btnToggleKnown.innerHTML = '<i class="fas fa-plus"></i> Add to Known';
                els.btnToggleKnown.className = "flex-1 py-3 px-6 rounded-xl font-bold transition-all duration-200 flex items-center justify-center gap-2 border border-amber-500/30 bg-amber-500/10 text-amber-400 hover:bg-amber-500/20 shadow-[0_0_15px_rgba(245,158,11,0.1)]";
            }
        }

        function updateWordUI(word, isKnown) {
            // Update all instances of this word in the text
            const allWords = els.detailText.querySelectorAll(`.word`);
            const lowerWord = word.toLowerCase();
            allWords.forEach(span => {
                if (span.dataset.word.toLowerCase() === lowerWord) {
                    if (isKnown) {
                        span.classList.remove('word-new');
                        span.classList.add('word-known');
                    } else {
                        span.classList.remove('word-known');
                        span.classList.add('word-new');
                    }
                }
            });
        }

        async function init() {
            try {
                // Load Stories
                const storiesResp = await fetch('data/stories.json');
                if (!storiesResp.ok) throw new Error('Failed to load stories');
                stories = await storiesResp.json();

                // Load Dictionary
                try {
                    const freqResp = await fetch('data/frequency.json');
                    if (freqResp.ok) {
                        const freqData = await freqResp.json();
                        buildDictionary(freqData);
                    }
                } catch (e) {
                    console.warn('Failed to load dictionary', e);
                }

                renderList();
                updateStats(); // Initial stats
            } catch (error) {
                console.error(error);
                els.grid.innerHTML = `<div class="col-span-full text-center text-red-500 py-10">Failed to load stories.<br>${error.message}</div>`;
            }
        }

        function buildDictionary(data) {
             for (const category in data) {
                if (Array.isArray(data[category])) {
                    data[category].forEach(item => {
                        const dutchWords = item.dutch.split(',').map(s => s.trim().toLowerCase());
                        dutchWords.forEach(w => {
                            if (!dictionary.has(w)) {
                                dictionary.set(w, item.english);
                            }
                        });
                    });
                }
             }
        }

        function renderList() {
            els.grid.innerHTML = '';
            stories.forEach(story => {
                const card = document.createElement('div');
                card.className = "bg-zinc-800/50 rounded-xl border border-white/5 overflow-hidden cursor-pointer transition-all duration-300 transform hover:-translate-y-1 hover:shadow-2xl hover:border-amber-500/30 group fade-in";
                card.onclick = () => openStory(story);

                // Use dummy image if not provided
                const imageUrl = story.image || 'https://placehold.co/400x300/18181b/a1a1aa?text=No+Image';

                card.innerHTML = `
                    <div class="h-44 overflow-hidden bg-zinc-800 relative">
                        <img src="${imageUrl}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 opacity-80 group-hover:opacity-100" onerror="this.src='https://placehold.co/400x300/18181b/a1a1aa?text=No+Image'">
                        <div class="absolute inset-0 bg-gradient-to-t from-zinc-900/90 to-transparent"></div>
                        <div class="absolute bottom-3 left-3 right-3 flex justify-between items-end">
                             <span class="text-xs font-bold text-white/90 bg-black/40 backdrop-blur px-2 py-1 rounded border border-white/10 uppercase tracking-wider">
                                <i class="fas fa-book mr-1 text-amber-500"></i> Read
                             </span>
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-bold text-lg text-zinc-100 mb-2 group-hover:text-amber-400 transition-colors line-clamp-1">${story.title}</h3>
                        <p class="text-sm text-zinc-400 line-clamp-2 leading-relaxed">${story.body.substring(0, 100)}...</p>
                    </div>
                `;
                els.grid.appendChild(card);
            });
        }

        function openStory(story) {
            // Populate Detail
            els.detailImage.src = story.image || 'https://placehold.co/600x600/18181b/a1a1aa?text=Story';
            els.detailTitle.textContent = story.title;

            // Calculate story stats
            currentStoryUniqueWords = new Set();
            const paragraphs = story.body.split('\n');
            paragraphs.forEach(p => {
                const tokens = p.split(/([a-zA-Z\u00C0-\u017F]+)/);
                tokens.forEach(t => {
                    if (/^[a-zA-Z\u00C0-\u017F]+$/.test(t)) {
                        currentStoryUniqueWords.add(t.toLowerCase());
                    }
                });
            });
            updateStats();

            // Format text: tokenize and highlight
            els.detailText.innerHTML = formatStoryText(story.body);

            // Dummy audio if missing
            els.audioPlayer.src = story.audio || '#';
            els.audioPlayer.load();

            // Switch View
            els.list.classList.add('hidden');
            els.detail.classList.remove('hidden');
            els.backBtn.classList.remove('hidden');

            // Update Header to show just the title
            els.headerTitle.innerHTML = `<span class="truncate max-w-[200px] text-zinc-300 text-base">${story.title}</span>`;
        }

        function formatStoryText(text) {
            const paragraphs = text.split('\n').filter(line => line.trim() !== '');

            return paragraphs.map(paragraph => {
                // Split by word boundaries, keeping the delimiters (words vs non-words)
                const tokens = paragraph.split(/([a-zA-Z\u00C0-\u017F]+)/);

                const html = tokens.map(token => {
                    if (/^[a-zA-Z\u00C0-\u017F]+$/.test(token)) {
                        // It is a word
                        const isKnown = knownWordsManager.isKnown(token);
                        const className = isKnown ? 'word-known' : 'word-new';
                        return `<span class="word ${className}" data-word="${token}">${token}</span>`;
                    } else {
                        // Punctuation or whitespace
                        return token;
                    }
                }).join('');

                return `<p class="mb-6">${html}</p>`;
            }).join('');
        }

        function showList() {
            currentStoryUniqueWords = null;
            updateStats();

            els.detail.classList.add('hidden');
            els.list.classList.remove('hidden');
            els.backBtn.classList.add('hidden');

            // Stop audio
            els.audioPlayer.pause();

            // Reset Header
            els.headerTitle.innerHTML = `<span class="bg-clip-text text-transparent bg-gradient-to-r from-amber-200 to-yellow-500">Dutch Dash</span>`;

            // Close card if open
            closeDefinitionCard();
        }

        // Initialize
        init();

    </script>
</body>

</html>